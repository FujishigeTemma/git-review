# git-review v2: JSON → SQLite 移行計画

## Context

git-review v2 では Agent Teams による並列レビュー（per-reviewer worktree/navigation）を導入する。これに伴い、複数エージェントが同時にコメントを読み書きする並行性が重要になる。JSON ファイル + flock では限界があるため、SQLite（WAL モード）に移行する。後方互換性は不要。

## 方針決定事項

- **Delete**: ハードデリートのみ。`deletedAt` フィールド廃止。非 root は re-parent、root はカスケード削除
- **Resolve**: GitHub 風の thread resolve 機能。root コメント単位で resolved/unresolved を管理
- **VSCode**: `git review state --json` CLI コマンド経由で状態取得。native モジュール不要
- **SQLite ライブラリ**: `modernc.org/sqlite`（pure Go、CGO 不要）
- **`commitIndex` 廃止**: コミットは SHA で識別。表示用の位置は commits テーブルの position から算出
- **List フィルタ**: `list` 1コマンドに統合。`<id>` で特定スレッド、`--commit`, `--unresolved`, `--creator`, `--file`, `--top-level` フィルタ
- **Workflow**: Implementation → Review → Improve → Finish（finish は improvement 後）
- **cherry-pick 完全廃止**: `-a` あり/なし両方とも checkout ベース。review branch 不要
- **`updated_at` 廃止**: update コマンドなし。コメントは作成後不変
- **Reviewer コンテキスト分類**: `next`/`jump`/`add`(非reply)/`status` は reviewer 特定が必要。`list`/`add -r`/`delete`/`resolve`/`finish`/`abort` は不要

## SQLite スキーマ

DB ファイル: `.git/review/review.db`

```sql
PRAGMA journal_mode = WAL;
PRAGMA foreign_keys = ON;

CREATE TABLE session (
    base_ref   TEXT PRIMARY KEY,
    branch     TEXT NOT NULL,
    created_at TEXT NOT NULL
);

CREATE TABLE commits (
    sha      TEXT PRIMARY KEY,
    message  TEXT NOT NULL,
    position INTEGER NOT NULL UNIQUE  -- 0-based display order
);

CREATE TABLE reviewers (
    name           TEXT PRIMARY KEY,
    current_sha    TEXT REFERENCES commits(sha)  -- NULL = before first commit; always an ORIGINAL commit SHA
);

CREATE TABLE comments (
    id             TEXT PRIMARY KEY,
    parent_id      TEXT REFERENCES comments(id) ON DELETE CASCADE,
    commit         TEXT NOT NULL REFERENCES commits(sha),
    file           TEXT,
    start_line     INTEGER,
    end_line       INTEGER,
    body           TEXT NOT NULL,
    resolved_at    TEXT,              -- NULL = unresolved, ISO 8601 = resolved
    resolved_by    TEXT,
    created_at     TEXT NOT NULL,
    created_by     TEXT NOT NULL
);

CREATE INDEX idx_comments_commit ON comments(commit);
CREATE INDEX idx_comments_parent ON comments(parent_id);
```

## パッケージ構成

```
internal/
  domain/
    format.go       — Pluralize(), FormatLineRange()（commands/helpers.go から移動）
    git/
      git.go        — Git ラッパー（既存 internal/git/ を移動 + worktree/WorktreeName 追加）
    output/
      output.go     — ターミナル出力（既存 internal/output/ を移動）
  db/               — sqlc 生成（uuid.UUID を使用）
  repository/
    repository.go   — Repository: DB 接続管理（Create/Open）+ WithTx
    convert.go      — db.Comment → domain 型変換
```

依存方向:
```
commands/      → repository/, domain/, domain/git/, domain/output/
repository/    → db/
domain/        → (null/v6 のみ — FormatLineRange が null.Int を使用)
domain/git/    → (exec のみ)
domain/output/ → (term のみ)
db/            → (uuid, null/v6)
```

## 実装ステップ

### Step 1: sqlc セットアップ + `internal/db/` パッケージ生成

**sqlc を使い、トップレベルに `schema.sql` と `query.sql` を配置、`internal/db/` にコード生成する。**

**新規ファイル:**
- `schema.sql` (トップレベル) — DDL
- `query.sql` (トップレベル) — 名前付きクエリ
- `sqlc.yaml` (トップレベル) — sqlc 設定
- `internal/db/` — sqlc が生成 (`db.go`, `models.go`, `query.sql.go`)

**sqlc.yaml:**

```yaml
version: "2"
sql:
  - engine: "sqlite"
    queries: "query.sql"
    schema: "schema.sql"
    gen:
      go:
        package: "db"
        out: "internal/db"
        overrides:
          - column: "comments.id"
            go_type:
              import: "github.com/google/uuid"
              package: "uuid"
              type: "UUID"
          - column: "comments.parent_id"
            go_type:
              import: "github.com/google/uuid"
              package: "uuid"
              type: "NullUUID"
          - db_type: "text"
            nullable: true
            go_type:
              import: "github.com/guregu/null/v6"
              package: "null"
              type: "String"
          - db_type: "integer"
            nullable: true
            go_type:
              import: "github.com/guregu/null/v6"
              package: "null"
              type: "Int"
```

**生成される型の例:**
```go
// db.Comment (generated by sqlc)
type Comment struct {
    ID          uuid.UUID   // TEXT PRIMARY KEY
    ParentID    uuid.NullUUID // TEXT nullable
    Commit      string      // TEXT NOT NULL
    File        null.String // TEXT nullable
    StartLine   null.Int    // INTEGER nullable
    EndLine     null.Int    // INTEGER nullable
    Body        string      // TEXT NOT NULL
    ResolvedAt  null.String // TEXT nullable
    ResolvedBy  null.String // TEXT nullable
    CreatedAt   string      // TEXT NOT NULL
    CreatedBy   string      // TEXT NOT NULL
}
```

`null.String` / `null.Int` は JSON で `null` にシリアライズされるため、`state` コマンドの JSON 出力がそのまま VSCode 拡張で使える。

**query.sql の主要クエリ:**
```sql
-- Session CRUD
-- name: InsertSession :exec
-- name: GetSession :one
-- name: SessionExists :one (SELECT COUNT(*))
-- name: DeleteSession :exec

-- Commits
-- name: InsertCommit :exec
-- name: ListCommits :many (ORDER BY position)
-- name: GetCommitByPosition :one
-- name: GetCommitBySHA :one
-- name: CountCommits :one
-- name: DeleteCommits :exec

-- Reviewers
-- name: InsertReviewer :exec
-- name: GetReviewer :one
-- name: ListReviewers :many
-- name: UpdateReviewerCurrent :exec
-- name: DeleteReviewers :exec

-- Comments
-- name: InsertComment :exec
-- name: GetComment :one
-- name: FindCommentByPrefix :one (WHERE id LIKE ?)
-- name: ListAllComments :many
-- name: ListCommentsByCommit :many
-- name: ReparentChildren :exec (UPDATE parent_id WHERE parent_id = ?)
-- name: DeleteComment :exec
-- name: DeleteAllComments :exec

-- Resolve
-- name: ResolveComment :exec (SET resolved_at, resolved_by WHERE id = ? AND parent_id IS NULL)
-- name: UnresolveComment :exec (SET resolved_at = NULL, resolved_by = NULL WHERE id = ?)

-- Filtered list queries
-- name: ListUnresolvedRoots :many (WHERE parent_id IS NULL AND resolved_at IS NULL)
-- name: ListCommentsByCreator :many (WHERE created_by = ?)
-- name: ListCommentsByFile :many (WHERE file = ?)
```

**Delete ロジック (コマンドハンドラ内でトランザクション):**

`ON DELETE CASCADE` を活用。recursive CTE 不要:

1. `q.GetComment()` で対象取得
2. `parent_id != NULL` (non-root) の場合のみ → `qtx.ReparentChildren()` で子を親の親に付替え
3. `qtx.DeleteComment()` で削除
   - Root の場合: CASCADE が全子孫を自動削除
   - Non-root の場合: 子は re-parent 済みなので CASCADE 対象なし

### Step 2: `internal/domain/comment.go` — スキップ

現行の関数はすべて v1 設計に依存しているため、このステップではスキップする。
v2 実装の過程で必要な domain 関数が判明した時点で作成する。

**`internal/domain/format.go`** は新規作成:
```go
package domain

// Pluralize returns singular if n == 1, plural otherwise.
func Pluralize(n int, singular, plural string) string

// FormatLineRange formats null.Int start/end as "N" or "N-M".
// Returns "" if start is null.
func FormatLineRange(startLine, endLine null.Int) string
```

これらは `commands/helpers.go` から移動。`FormatLineRange` のシグネチャは sqlc 生成型 `null.Int` に合わせて変更。

### Step 3: `internal/domain/git/` と `internal/domain/output/` に移動

既存の `internal/git/` と `internal/output/` を `internal/domain/` 配下に移動。
メソッドセットは ~15 メソッドなので単一ファイルのまま。

**DELETE（cherry-pick/review-branch 廃止）:**
- `CherryPickNoCommit()`, `CherryPickAbort()`
- `CheckoutNewBranch()`, `DeleteBranch()`
- `ResetHard()`
- `HasStagedChanges()`, `Commit()`

**ADD（worktree/checkout ベースレビュー）:**
- `WorktreeAdd(path, ref string) error` — `git worktree add <path> --detach`
- `WorktreeRemove(path string) error` — `git worktree remove <path> --force`
- `ReadTreeReset(ref string) error` — `git read-tree -u --reset <ref>`
- `CommonDir() (string, error)` — `git rev-parse --git-common-dir`（reviewer 検出用）
- `DiffStagedStat() (string, error)` — `git diff --staged --stat`（jump/next 出力用）
- `WorktreeName() (string, error)` — reviewer 検出（下記参照）

**KEEP（コア、v2 で使用）:**
- `Run()`, `RunSilent()` — コア実行
- `GitDir()`, `CurrentBranch()`, `RefExists()` — 検査
- `IsClean()` — `start` のバリデーションに有用
- `MergeBase()`, `RevList()` — コミット範囲計算（`start` 用）
- `Oneline()`, `Subject()`, `FullMessage()` — コミット表示
- `Checkout()` — jump/next（parent checkout）
- `NotesAppend()` — finish（git notes 書込み）

**`WorktreeName()` メソッド（reviewer 検出を git package に統合）:**

```go
// WorktreeName returns the worktree name if running inside a linked worktree,
// or "" if in the main worktree. Uses git plumbing (--git-dir vs --git-common-dir).
func (g *Git) WorktreeName() (string, error) {
    gitDir, err := g.Run("rev-parse", "--git-dir")
    if err != nil {
        return "", err
    }
    commonDir, err := g.Run("rev-parse", "--git-common-dir")
    if err != nil {
        return "", err
    }
    if gitDir == commonDir {
        return "", nil // main worktree
    }
    return filepath.Base(gitDir), nil
}
```

`detectReviewer()` は `commands/helpers.go` から `git.Git` のメソッドに移動。パス規約に依存せず git plumbing で検出。

### Step 4: `internal/repository/` 作成

薄い Repository。DB 接続管理 + WithTx + domain 型変換:

```go
package repository

type Repository struct {
    conn *sql.DB
    q    *db.Queries
}

// Create creates a new review DB (mkdir + open + migrate). Used by `start`.
func Create(dbPath string) (*Repository, error)

// Open opens an existing review DB. Returns error if not found. Used by all other commands.
func Open(dbPath string) (*Repository, error)

func (r *Repository) Queries() *db.Queries
func (r *Repository) WithTx(ctx context.Context, fn func(*db.Queries) error) error
func (r *Repository) Close() error
```

Session / Comment / Commit / Reviewer は sqlc 生成型をそのまま使う（`r.Queries().GetSession()` 等）。

### Step 5: `main.go` 更新 — Kong `AfterApply` フック

手動の `setup()` 関数と `skill` コマンドの特別分岐を廃止し、Kong の `AfterApply` フックで依存注入を宣言的に行う。

```go
type CLI struct {
    Start     commands.StartCmd     `cmd:"" default:"withargs"`
    Add       commands.AddCmd       `cmd:""`
    Next      commands.NextCmd      `cmd:""`
    Jump      commands.JumpCmd      `cmd:""`
    List      commands.ListCmd      `cmd:""`
    Status    commands.StatusCmd    `cmd:""`
    Delete    commands.DeleteCmd    `cmd:""`
    Resolve   commands.ResolveCmd   `cmd:""`
    Unresolve commands.UnresolveCmd `cmd:""`
    Finish    commands.FinishCmd    `cmd:""`
    Abort     commands.AbortCmd     `cmd:""`
    State     commands.StateCmd     `cmd:"" hidden:""`
    Skill     commands.SkillCmd     `cmd:""`

    repo *repository.Repository // unexported, for cleanup in main
}

// AfterApply runs after flag parsing, before Run().
// Binds shared dependencies to Kong context for injection into Run().
func (c *CLI) AfterApply(ctx *kong.Context) error {
    ctx.Bind(output.New())

    if ctx.Selected().Name == "skill" {
        return nil // skill needs only SkillContent + Output (already bound)
    }

    g := &git.Git{WorkDir: "."}
    gitDir, err := g.GitDir()
    if err != nil {
        return fmt.Errorf("not in a git repository")
    }
    ctx.Bind(g)

    dbPath := filepath.Join(gitDir, "review", "review.db")
    var repo *repository.Repository
    if ctx.Selected().Name == "start" {
        repo, err = repository.Create(dbPath)
    } else {
        repo, err = repository.Open(dbPath)
    }
    if err != nil {
        return err
    }
    c.repo = repo
    ctx.Bind(repo)

    return nil
}

func main() {
    var cli CLI
    ctx := kong.Parse(&cli,
        kong.Name("git-review"),
        kong.Description("Commit review workflow for AI Agent collaboration"),
        kong.UsageOnError(),
        kong.Bind(commands.SkillContent(skillMD)),
    )
    defer func() {
        if cli.repo != nil {
            cli.repo.Close()
        }
    }()

    if err := ctx.Run(); err != nil {
        msg := err.Error()
        if code := ergo.CodeOf(err); !code.IsZero() {
            msg = strings.TrimPrefix(msg, code.String()+": ")
        }
        fmt.Fprintf(os.Stderr, "Error: %s\n", msg)
        os.Exit(1)
    }
}
```

**主な変更点:**
- `setup()` 関数を廃止 → `AfterApply` フックに統合
- `skill` コマンドの `if` 分岐を廃止 → `skill` は `Run()` シグネチャで `*git.Git` / `*repository.Repository` を要求しない
- `ctx.Run(g, repo, out)` → `ctx.Run()`（Kong が型マッチングで注入）
- `repo.Close()` は `cli.repo` への参照保持 + defer で管理

**コマンドシグネチャ例:**
```go
func (c *SkillCmd) Run(content SkillContent, out *output.Output) error
func (c *AddCmd) Run(g *git.Git, repo *repository.Repository, out *output.Output) error
```

### `next` / `jump` の仕組み

**コミットの閲覧メカニズム (checkout + read-tree):**

`jump(target)` が全ての基本操作。`next` は「次コミットへの jump」として実装を共有。

```bash
# jump(target) の一般形:
git checkout <parent_of(target)>     # HEAD = parent
git read-tree -u --reset <target>    # index + working tree = target
```

結果:
- HEAD = parent → `git diff --staged` = target のコミット差分（Staged Changes）
- Index + working tree = target → フルコードベース閲覧可
- VSCode Source Control の「Staged Changes」にコミットの変更ファイルが表示される

**具体例 (A=base, B=#1, C=#2, D=#3):**
```bash
git worktree add .git/review/worktrees/security --detach

# (in .git/review/worktrees/security)
# next → B (最初のコミット)
git checkout <A>
git read-tree -u --reset <B>        # staged: A→B の差分
# (review)
# next → C
git checkout <B>
git read-tree -u --reset <C>        # staged: B→C の差分
# (review)
# next → D
git checkout <C>
git read-tree -u --reset <D>        # staged: C→D の差分
# (review)
# jump B
git checkout <A>
git read-tree -u --reset <B>        # staged: A→B の差分
```

**`jump` のフロー:**
```
1. g.WorktreeName() で reviewer 特定
2. repo.Queries().FindCommitBySHAPrefix(hashPrefix) → target commit を取得
3. target の parent を特定:
   - target.position == 0 → parent = session.base_ref
   - target.position > 0  → parent = commits[position-1].sha
4. git checkout <parent>
5. git read-tree -u --reset <target.sha>
6. repo.Queries().UpdateReviewerCurrent(name, target.sha)
7. diff stat 表示: git diff --staged --stat
```

**`next` のフロー:**
```
1. g.WorktreeName() で reviewer 特定
2. repo.Queries().GetReviewer(name) → current_sha を取得
3. current_sha が NULL の場合: target = commits[position=0]
   current_sha が非 NULL の場合: target = commits[current_position + 1]
4. 最後のコミットの場合: "All commits reviewed" メッセージ → return
5. jump(target) と同じ処理 (steps 3-7)
```

**Reviewer 検出: `g.WorktreeName()` メソッド**

cwd のパス文字列解析ではなく、`git.Git` の `WorktreeName()` メソッド（Step 3 で追加）を使う:

```go
name, err := g.WorktreeName()
// name == "" → main worktree（無名 reviewer）
// name == "security" → security reviewer
```

`git worktree add .git/review/worktrees/security --detach` → git が `<gitdir>/worktrees/security/` にメタデータ作成 → `rev-parse --git-dir` で `security` を抽出。パス規約に依存しない。

**Worktree パスについて:**
- `<gitdir>/review/worktrees/<name>/` は規約で決まるため、DB に保存不要
- `git worktree add <path> --detach` で作成、`git worktree remove <path>` で削除

**必要な情報の確認:**

| 操作                   | 必要な情報                 | スキーマのソース                                 |
| ---------------------- | -------------------------- | ------------------------------------------------ |
| 現在位置の取得         | reviewer name, current_sha | `reviewers.current_sha`                          |
| 次のコミット特定       | current position + 1       | `commits.position` (current_sha → position → +1) |
| 特定コミットへジャンプ | target hash prefix         | `commits.sha` (LIKE prefix)                      |
| Parent の特定          | target.position, base_ref  | `commits.position` + `session.base_ref`          |
| Checkout + read-tree   | parent sha, target sha     | 上記から導出                                     |
| Diff 表示              | (staged changes から自動)  | `git diff --staged --stat`                       |

→ **現在のスキーマで必要な情報は全て揃っている。**

### Step 6: `commands/*.go` 全コマンド更新

全コマンドの `Run` シグネチャ:

```go
func (c *AddCmd) Run(g *git.Git, repo *repository.Repository, out *output.Output) error
```

**`commands/helpers.go`:**
- `requirePhase()` → `requireActive(repo)` に置換（`repo.Queries().SessionExists()` チェック）
- `detectReviewer()` → 削除（`g.WorktreeName()` に移動済み、Step 3 参照）
- `applyCommit()` → 削除（cherry-pick 廃止）
- `autoCommitIfNeeded()` → 削除（cherry-pick 廃止）
- `ensureClean()` → 削除（checkout が dirty check）
- `pluralize()` → `domain.Pluralize()` に移動（Step 2 参照）
- `formatLineRange()` → `domain.FormatLineRange()` に移動（Step 2 参照）

移行後、`helpers.go` には `requireActive(repo)` のみ残る。各コマンドの `Run()` 冒頭で明示的に呼び出す（Option A: 明示的、1行で済む）。`start` はセッション作成側、`skill` は不要なので呼ばない。

**`commands/start.go`:**
- `StartCmd` に `-a` フラグ追加: `Name string \`short:"a" help:"Reviewer role name"\``
- `rd.Init(...)` → `repo.WithTx()` 内で `q.InsertSession()` + `q.InsertCommit()` × N + `q.InsertReviewer(name, nil)`
- `rd.Phase()` → `repo.Queries().SessionExists()`
- cherry-pick 関連ロジック完全削除
- `-a` あり: `g.WorktreeAdd(worktreePath, "--detach")` で worktree 作成
- `-a` なし: (worktree なし、current tree で作業)

**`commands/jump.go`:** **新規追加（next の基盤）**
```go
type JumpCmd struct {
    Hash string `arg:"" help:"Commit hash (or prefix) to jump to."`
}
```
- `main.go` の CLI struct に `Jump JumpCmd \`cmd:"" help:"Jump to a specific commit."\`` 追加
- コア実装 `jumpTo(g, repo, name, target)`:
  1. target の parent 特定 (position==0 → base_ref, else → commits[pos-1])
  2. `git checkout <parent>`
  3. `git read-tree -u --reset <target.sha>`
  4. `repo.Queries().UpdateReviewerCurrent(name, target.sha)`
  5. `git diff --staged --stat` で差分表示

**`commands/next.go`:**
- `rd.Load()` → `repo.Queries().GetReviewer(name)` + `repo.Queries().ListCommits()`
- 次のコミットを特定 → `jumpTo()` を呼び出し（jump と実装共有）
- `autoCommitIfNeeded()`, `ensureClean()` 削除
- 最終コミット到達時: メッセージ表示のみに変更

**`commands/add.go`:**
- mutex 関連コード削除
- `rd.LoadComments()` + `rd.SaveComments()` → `repo.Queries().InsertComment()` (単一 INSERT)
- `rd.Load()` → `repo.Queries().GetReviewer(name)` + `repo.Queries().GetCommitBySHA()`
- `comment.FindByID(comments, ...)` → `repo.FindCommentByPrefix(id)`
- `author` → `created_by`
- Reviewer コンテキスト分岐:
  - reply あり (`-r`): reviewer 不要、commit は親コメントから継承
  - reply なし: `g.WorktreeName()` 必要、commit は reviewer の current_sha

**`commands/list.go`:**
- mutex 削除
- `rd.LoadComments()` → `repo.AllComments()`
- `rd.Load()` → `repo.Queries().GetSession()` + `repo.Queries().ListCommits()`
- `c.CommitIndex == i` → `c.Commit == sha` でフィルタ

**`commands/delete.go`:**
- mutex 削除
- load-modify-save パターン → `repo.WithTx()` 内で delete ロジック
- `hardDeleteAndCleanup()` 関数削除

**`commands/status.go`:**
- mutex 削除
- `comment.ForCommit(comments, i)` → SHA ベースフィルタ (`repo.CommentsByCommit()` or in-memory)

**`commands/finish.go`:**
- mutex 削除
- `buildCommitNotes()` の `commitIndex` 参照を SHA ベースに変更
- `rd.Remove()` → worktree クリーンアップ + `repo.Close()` + `os.RemoveAll(reviewDir)`
- Worktree クリーンアップ: `repo.Queries().ListReviewers()` → 各 reviewer について `g.WorktreeRemove(path)`

**`commands/abort.go`:**
- `rd.Load()` → `repo.Queries().GetSession()`
- `rd.Remove()` → worktree クリーンアップ + `repo.Close()` + `os.RemoveAll(reviewDir)`
- Worktree クリーンアップ: `repo.Queries().ListReviewers()` → 各 reviewer について `g.WorktreeRemove(path)`
- cherry-pick abort / reset hard 削除

### Step 7: 新規コマンド `commands/resolve.go` + `commands/unresolve.go` 追加

`resolve -u` フラグでコマンドの動作を否定する設計を廃止し、2つの独立コマンドに分離。

**`commands/resolve.go`:**
```go
type ResolveCmd struct {
    ID   string `arg:"" help:"ID (or prefix) of the thread to resolve."`
    Name string `short:"a" help:"Who resolved it." env:"GIT_REVIEW_AUTHOR"`
}
```

- `git review resolve <id>` — root コメントの `resolved_at` / `resolved_by` を設定
- root 以外の ID を指定した場合はエラー

**`commands/unresolve.go`:**
```go
type UnresolveCmd struct {
    ID string `arg:"" help:"ID (or prefix) of the thread to unresolve."`
}
```

- `git review unresolve <id>` — root コメントの `resolved_at` / `resolved_by` を NULL に戻す
- root 以外の ID を指定した場合はエラー

### Step 7b: `commands/list.go` フィルタ拡張

```go
type ListCmd struct {
    ID         string `arg:"" optional:"" help:"Comment ID to show specific thread."`
    Commit     string `help:"Filter by commit hash prefix." name:"commit"`
    Unresolved bool   `help:"Show only unresolved threads." name:"unresolved"`
    Creator    string `help:"Filter by creator." name:"creator"`
    File       string `help:"Filter by file path." name:"file"`
    TopLevel   bool   `help:"Show only top-level comments (no replies)." name:"top-level"`
}
```

**フィルタの適用:**
- `<id>` 指定時: そのスレッド（root + 全 descendants）のみ表示。他フィルタは無視
- `--commit`: `repo.Queries().ListCommentsByCommit(sha)` でフィルタ
- `--unresolved`: root コメントの `resolved_at IS NULL` でフィルタ
- `--creator`: `repo.Queries().ListCommentsByCreator(creator)` でフィルタ
- `--file`: `repo.Queries().ListCommentsByFile(file)` でフィルタ
- `--top-level`: replies を表示しない
- フィルタは組合せ可能（in-memory で AND 結合）

**出力の resolved 表示:**
```
✓ [019516c0] Use bcrypt instead of md5 @security [resolved by implementer]
  [019516c1] Fixed: switched to argon2 @implementer
```

### Step 7c: 新規コマンド `commands/state.go` 追加

`git review state` — VSCode 拡張向け JSON 出力:

```go
type StateCmd struct{}
func (c *StateCmd) Run(g *git.Git, repo *repository.Repository, out *output.Output) error {
    // repo.Queries().SessionExists() == false → "null\n" を出力
    // それ以外 → session + commits + current + comments を JSON で出力
}
```

出力形式:
```json
{
  "baseRef": "main",
  "branch": "feature/auth",
  "commits": ["abc123...", "def456..."],
  "current": 0,
  "comments": [...]
}
```

`main.go` の CLI struct に追加: `State StateCmd \`cmd:"" help:"..." hidden:""\``

### Step 8: 削除するファイル

- `internal/state/state.go`
- `internal/state/state_test.go`
- `internal/state/filemutex.go`
- `internal/state/filemutex_test.go`
- `internal/comment/comment.go` （domain 関数は実装時に作成）
- `internal/comment/comment_test.go`
- `internal/git/git.go` （`internal/domain/git/git.go` に移動済み）
- `internal/git/git_test.go`
- `internal/output/output.go` （`internal/domain/output/output.go` に移動済み）
- `internal/output/output_test.go`

### Step 9: テスト更新

**新規:** `internal/domain/format_test.go`
- `Pluralize()` テスト
- `FormatLineRange()` テスト（null.Int のバリエーション）

**更新:** `commands/add_test.go`, `commands/helpers_test.go`
- `*state.Dir` 依存を削除

**更新:** `tests/e2e_test.go`, `tests/testutil_test.go`
- `comments.json` 読み取り → `git review state` コマンド出力パース or SQLite 直接読み
- ファイル存在アサーション: `comments.json` → `review.db`

**追加テスト:**
- `jump` コマンド E2E テスト（hash prefix での jump、存在しない hash でのエラー）
- `resolve` / `unresolve` E2E テスト
- `state` コマンド JSON 出力テスト
- worktree 作成/削除テスト（`start -a` → worktree 存在確認、`finish` → worktree 削除確認）
- `g.WorktreeName()` 単体テスト（worktree 内、main repo、エラーケース）
- `list` フィルタ組合せテスト（`--commit` + `--unresolved`、`--creator` + `--file` 等）
- implementer フロー E2E テスト（`list` → `add -r` → `resolve` → `list --unresolved`）

### Step 10: VSCode 拡張更新

**`src/types.ts`:**
- `commitIndex` 削除
- `deletedAt` 削除
- `commitMessage` 削除（commits テーブルから取得）
- `author` → `createdBy` (reviewers FK)
- `resolvedAt`, `resolvedBy` 追加
- `originalBranch` → `baseRef`、`reviewBranch` → `branch`

**`src/reviewManager.ts`:**
- `resolveReviewDir()`, `readFile()`, `loadComments()` 削除
- `isActive()` → `git review state` の出力が null でないか確認
- `getState()` → `git.review("state")` + `JSON.parse()`

**`src/commentController.ts`:**
- `c.commitIndex === state.current` → `c.commit === state.commits[state.current]`
- `c.deletedAt` 参照削除

**`src/statusBar.ts`:**
- フィールド名更新 (`originalBranch` → `baseRef` 等)

**`src/extension.ts`:**
- `.git/HEAD` ウォッチャーに加えて `.git/review/review.db` も監視

### Step 11: `go.mod` 更新 + sqlc generate

```bash
go get modernc.org/sqlite
go get github.com/guregu/null/v6
sqlc generate
go mod tidy
```

`google/uuid` を direct dependency に変更（既に使用中だが indirect になっている）。

### Step 12: SKILL.v2.md 仕様更新 + リネーム

Data Storage セクションを SQLite スキーマに書き換え:
- `comments.json` → `review.db`
- `.comments.lock` 削除（SQLite WAL が代替）
- `comments.json` スキーマ → SQLite テーブル定義
- `commitIndex` フィールド削除
- `deletedAt` フィールド削除
- Delete Behavior セクション更新
- CLI Quick Reference: `resolve -u <id>` → `unresolve <id>` に分離

**最後に `SKILL.v2.md` → `SKILL.md` にリネーム**（v1 を置換）。`//go:embed SKILL.md` はそのまま。

## ファイル変更サマリ

| ファイル                                    | 操作                                                     |
| ------------------------------------------- | -------------------------------------------------------- |
| `schema.sql` (top-level)                    | **新規**                                                 |
| `query.sql` (top-level)                     | **新規**                                                 |
| `sqlc.yaml` (top-level)                     | **新規**                                                 |
| `internal/db/` (生成)                       | **新規** (sqlc generate: db.go, models.go, query.sql.go) |
| `internal/domain/format.go`                 | **新規** (helpers.go から Pluralize, FormatLineRange 移動)|
| `internal/domain/git/git.go`                | **新規** (internal/git/ から移動 + worktree 追加)        |
| `internal/domain/output/output.go`          | **新規** (internal/output/ から移動)                     |
| `internal/repository/repository.go`         | **新規**                                                 |
| `internal/repository/convert.go`            | **新規**                                                 |
| `commands/resolve.go`                       | **新規**                                                 |
| `commands/unresolve.go`                     | **新規**                                                 |
| `commands/state.go`                         | **新規**                                                 |
| `commands/jump.go`                          | **新規**                                                 |
| `internal/state/state.go`                   | **削除**                                                 |
| `internal/state/state_test.go`              | **削除**                                                 |
| `internal/state/filemutex.go`               | **削除**                                                 |
| `internal/state/filemutex_test.go`          | **削除**                                                 |
| `internal/comment/comment.go`               | **削除** (domain 関数は実装時に作成)                     |
| `internal/comment/comment_test.go`          | **削除**                                                 |
| `internal/git/git.go`                       | **削除** (domain/git/ に移動)                            |
| `internal/git/git_test.go`                  | **削除**                                                 |
| `internal/output/output.go`                 | **削除** (domain/output/ に移動)                         |
| `internal/output/output_test.go`            | **削除**                                                 |
| `go.mod`                                    | 更新                                                     |
| `main.go`                                   | 更新 (AfterApply フック導入)                             |
| `commands/start.go`                         | 更新                                                     |
| `commands/add.go`                           | 更新                                                     |
| `commands/next.go`                          | 更新                                                     |
| `commands/list.go`                          | 更新                                                     |
| `commands/delete.go`                        | 更新                                                     |
| `commands/status.go`                        | 更新                                                     |
| `commands/finish.go`                        | 更新                                                     |
| `commands/abort.go`                         | 更新                                                     |
| `commands/helpers.go`                       | 更新 (requireActive のみ残る)                            |
| `commands/add_test.go`                      | 更新                                                     |
| `commands/helpers_test.go`                  | 更新                                                     |
| `tests/e2e_test.go`                         | 更新                                                     |
| `tests/testutil_test.go`                    | 更新                                                     |
| `vscode-extension/src/types.ts`             | 更新                                                     |
| `vscode-extension/src/reviewManager.ts`     | 更新                                                     |
| `vscode-extension/src/commentController.ts` | 更新                                                     |
| `vscode-extension/src/statusBar.ts`         | 更新                                                     |
| `vscode-extension/src/extension.ts`         | 更新                                                     |
| `SKILL.v2.md`                               | 更新 → 最後に `SKILL.md` にリネーム                     |

## 検証手順

1. `go build ./...` — 循環依存なし
2. `go test ./...` — 全テスト通過
3. `go vet ./...` — 警告なし
4. 手動: `start -a security` → `next` → `add` → `jump` → `list` → `resolve` → `unresolve` → `finish`
5. 手動: `start`（`-a` なし）→ 単一 reviewer フローの動作確認
6. 手動: `state` JSON 出力
7. 手動: worktree 確認 — `git review start main -a security` → `.git/review/worktrees/security/` が存在 → `finish` で削除
8. 手動: jump 確認 — `git review start main -a test` → `next` → `jump <first-commit-hash>` → status で位置確認
9. 手動: implementer フロー — `git review list` → `git review add -r <id> -a impl "Fixed"` → `git review resolve <id>` → `git review list --unresolved` で対象が消えることを確認
10. VSCode: 拡張ビルド (`pnpm run build`) → 起動してレビュー操作確認
